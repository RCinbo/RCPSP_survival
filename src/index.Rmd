---
title: "RCPSP-survival: Explorative analysis"
output:
  bookdown::html_document2:
    toc: true
    fig_caption: true
  bookdown::pdf_book:
    toc: true
    fig_caption: true
bibliography: references.bib
site: bookdown::bookdown_site
delete_merged_file: true
---

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
library(kableExtra)
library(readxl)
library(rprojroot)
library(tidyverse)
library(zoo)
library(survival)
library(ggsurvfit)
library(knitr)
library(patchwork)
```
# Introduction

For each instance, several parameters describe the network topology, complexity, and resources (Table \@ref(tab:parameter)). 

```{r parameter, echo = FALSE, message = FALSE, warning = FALSE}
parameters <- read_excel(
  path = find_root_file(
    "data", "RCPLIB (Parameters and BKS).xlsx",
    criterion = has_file("RCPSP_survival.Rproj")
  ),
  sheet = "Parameter Overview",
  skip = 2
) %>%
  rename(Category = `Paramater category`) %>%
  dplyr::select(1:3) %>%
  mutate(Category = na.locf(Category))

n_nc <- sum(parameters$Category == "Network Topology")
n_ci <- sum(parameters$Category == "Complexity indictors")
n_rp <- sum(parameters$Category == "Resource parameters")

parameters %>%
  dplyr::filter(Category %in% c("Network Topology",
                                "Complexity indictors",
                                "Resource parameters")) %>%
  dplyr::select(-Category) %>%
  kable(booktabs = TRUE,
        caption = "Instance topology, complexity, and resource parameters.",
        col.names = c("", "")) %>%
  kableExtra::group_rows(group_label = "Network Topology",
                         start_row = 1,
                         end_row = n_nc) %>%
  kableExtra::group_rows(group_label = "Complexity indictors",
                         start_row = n_nc + 1,
                         end_row = n_nc + n_ci) %>%
  kableExtra::group_rows(group_label = "Resource parameters",
                         start_row = 1 + n_nc + n_ci,
                         end_row = n_nc + n_ci + n_rp) %>%
  kableExtra::kable_styling()
```
# Results

## CV dataset
The Coelho-Vanhoucke (CV) dataset consists of 623 RCPSP instances, first described in @cv2020 that can be downloaded from [here](https://www.projectmanagement.ugent.be/research/data). As of September 2023, three different authors have submitted their run-time results and best (or optimal) solution to each of the instances;
- @cv2020 designed this dataset with difficult to solve instances and provided their solutions to some of them.
- @watermeyer2022partition was the first one to add further solutions to improve upon the already achieved results.
- @creemers2021 recently added his results and is able to solve almost all instances.

In this chapter, we compare the run times reported by each of the researchers for each of the instances. If a researcher is unable to find the optimal solution (within a certain time limit), they might still report the best solution that was found.

```{r load-cv-data, echo = FALSE, message = FALSE, warning = FALSE}
data_cv <- read_excel(
  path = find_root_file(
    "data", "RCPLIB (Parameters and BKS).xlsx",
    criterion = has_file("RCPSP_survival.Rproj")
  ),
  sheet = "CV",
  skip = 0
)

data_cv_cv <- read_csv2(
  file = find_root_file(
    "data", "CV_CV.csv",
    criterion = has_file("RCPSP_survival.Rproj")
  ),
  skip = 6
) %>%
  as.data.frame() %>%
  dplyr::select(1:4) %>%
  mutate(author = "CV")

data_cv_wz <- read_csv2(
  file = find_root_file(
    "data", "CV_WZ.csv",
    criterion = has_file("RCPSP_survival.Rproj")
  ),
  skip = 6
) %>%
  dplyr::select(1:4) %>%
  mutate(author = "WZ")

data_cv_c <- read_csv2(
  file = find_root_file(
    "data", "CV_C.csv",
    criterion = has_file("RCPSP_survival.Rproj")
  ),
  skip = 6
) %>%
  dplyr::select(1:4) %>%
  mutate(author = "C")
data_cv_all <- data_cv_cv %>%
  rbind(data_cv_wz) %>%
  rbind(data_cv_c) %>%
  mutate(Type = as.factor(Type),
         author = factor(as.factor(author),
                         levels = c("CV", "WZ", "C")))
```

### Run times: Kaplan Meier

In this chapter, we look at the different run times to find an optimal solution. If an optimal solution is not found, a lower bound and/or heuristic solution was reported instead. If a non-optimal solution is reported, we consider the run time to be right-censored.

Figure \@ref(fig:cv-compare-authors) shows the run times for different authors. It can be seen than @cv2020 solves none of the instances to optimality. They designed this dataset to be difficult such that it can serve as a benchmarking dataset for new RCPSP algorithms. @watermeyer2022partition can solve almost 30% of all instances to optimality. Since they stop their algorithm after 3600 seconds, all other instances are right censored at that time. Lastly, @creemers2021 allows for a maximum run time of 48 hours. If no optimal solution is found after that, the instance is right-censored. 

Table \@ref(tab:cv-compare-authors-quantiles) shows different quantiles for each author with log-log 95% confidence intervals.

```{r cv-compare-authors, fig.cap="Comparing the run time for the different authors.", echo = FALSE, message = FALSE, warning = FALSE}
data_cv_all_1 <- data_cv_all %>%
  group_by(ID, author) %>%
  summarize(is_optimal = any(Type == "optimal"),
            Time = mean(Time)) %>%
  ungroup() %>%
  mutate(Time = ifelse(is_optimal,
                       Time,
                       ifelse(author == "C",
                              48*60*60*1000,
                              ifelse(author == "WZ",
                                     3600000,
                                     20*60*60*1000))
                       ),
         status = 1*is_optimal)
s1 <- survfit(Surv(Time, status) ~ author, data = data_cv_all_1)
survfit2(Surv(Time, status) ~ author, data = data_cv_all_1) %>%
  ggsurvfit() +
  labs(
    x = "milliseconds",
    y = "Proportion of instances not solved to optimality"
    )
```

```{r cv-compare-authors-quantiles, fig.cap="Comparing the run time for the different authors.", echo = FALSE, message = FALSE, warning = FALSE}
library(biostatUZH)
qKM10 <- quantileKM(data_cv_all_1$Time, data_cv_all_1$status,
                    group = data_cv_all_1$author, quant = 0.1,
                    conf.level = 0.95, conf.type = "log-log")
qKM25 <- quantileKM(data_cv_all_1$Time, data_cv_all_1$status,
                    group = data_cv_all_1$author, quant = 0.25,
                    conf.level = 0.95, conf.type = "log-log")
qKM50 <- quantileKM(data_cv_all_1$Time, data_cv_all_1$status,
                    group = data_cv_all_1$author, quant = 0.5,
                    conf.level = 0.95, conf.type = "log-log")
qKM75 <- quantileKM(data_cv_all_1$Time, data_cv_all_1$status, 
                  group = data_cv_all_1$author, quant = 0.75,
                  conf.level = 0.95, conf.type = "log-log")
qKM90 <- quantileKM(data_cv_all_1$Time, data_cv_all_1$status,
                    group = data_cv_all_1$author, quant = 0.9,
                    conf.level = 0.95, conf.type = "log-log")

qKM <- data_frame(author = c("CV", "WZ", "C"),
                  q90 = qKM90$quantities %>%
                    as.data.frame() %>%
                    mutate(q = sprintf("%.0f, [%.0f, %.0f]", quantile,
                                       lower.ci, upper.ci)) %>% dplyr::pull(q),
                  
                  q75 = qKM75$quantities %>%
                    as.data.frame() %>%
                    mutate(q = sprintf("%.0f, [%.0f, %.0f]", quantile,
                                       lower.ci, upper.ci)) %>% dplyr::pull(q),

                  q50 = qKM50$quantities %>%
                    as.data.frame() %>%
                    mutate(q = sprintf("%.0f, [%.0f, %.0f]", quantile,
                                       lower.ci, upper.ci)) %>% dplyr::pull(q),

                  q25 = qKM25$quantities %>%
                    as.data.frame() %>%
                    mutate(q = sprintf("%.0f, [%.0f, %.0f]", quantile,
                                       lower.ci, upper.ci)) %>% dplyr::pull(q),

                  q10 = qKM10$quantities %>%
                    as.data.frame() %>%
                    mutate(q = sprintf("%.0f, [%.0f, %.0f]", quantile,
                                       lower.ci, upper.ci)) %>% dplyr::pull(q))
qKM %>%
  kable(caption = "Quantiles and confidence intervals for the time to solve to optimality.",
        booktabs = TRUE) %>%
  kableExtra::kable_styling()
```

### Runtime with different instance parameters

```{r display-parameter-analysis, results = "asis", echo = FALSE, eval = TRUE}
to_do <- c("CNC", "AD", "TF", "Wprec", "RF", "RU", "RS", "RC")
rmd <- sapply(
  to_do,
  function(id) {
    knit_expand("_cv_analysis_parameter.Rmd", id = id)
  }
) %>%
  paste(collapse = "\n\n")
cat(knit(text = rmd, quiet = TRUE))
```

